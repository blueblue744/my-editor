<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>CodePlay Editor</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#111827">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸš€</text></svg>">

    <!-- å¿…é ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['sans-serif'], mono: ['Menlo', 'Monaco', 'Consolas', 'monospace'] },
            colors: { editor: { bg: '#1e1e1e', sidebar: '#252526', active: '#37373d', border: '#333' } }
          },
        },
      }
    </script>
    <style>
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #1e1e1e; }
      ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
      body { margin: 0; overflow: hidden; background-color: #111827; touch-action: manipulation; }
      #root { height: 100vh; height: 100dvh; }
      input, textarea, button, select { font-size: 14px; }
      textarea::placeholder { color: #555; opacity: 0.5; }
      .modal-overlay { background-color: rgba(0,0,0,0.7); backdrop-filter: blur(2px); }
    </style>
  </head>
  <body>
    <div id="root" class="w-screen flex flex-col"></div>

    <script type="text/babel" data-presets="react,typescript">
      const { useState, useEffect, useRef, useMemo } = React;
      const e = React.createElement;

      // --- ã‚¢ã‚¤ã‚³ãƒ³ ---
      const Icon = ({ path, size = 18, className = "" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{ __html: path }} />
      );
      const Icons = {
        Menu: (p) => <Icon {...p} path='<line x1="3" x2="21" y1="6" y2="6"/><line x1="3" x2="21" y1="12" y2="12"/><line x1="3" x2="21" y1="18" y2="18"/>' />,
        Plus: (p) => <Icon {...p} path='<path d="M5 12h14"/><path d="M12 5v14"/>' />,
        Trash2: (p) => <Icon {...p} path='<path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>' />,
        Folder: (p) => <Icon {...p} path='<path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/>' />,
        File: (p) => <Icon {...p} path='<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/>' />,
        Code: (p) => <Icon {...p} path='<polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>' />,
        Play: (p) => <Icon {...p} path='<polygon points="5 3 19 12 5 21 5 3"/>' />,
        List: (p) => <Icon {...p} path='<line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>' />,
        RotateCcw: (p) => <Icon {...p} path='<path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/>' />,
        SelectAll: (p) => <Icon {...p} path='<path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>' />,
        Download: (p) => <Icon {...p} path='<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/>' />,
        Upload: (p) => <Icon {...p} path='<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/>' />,
        Archive: (p) => <Icon {...p} path='<rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/>' />,
        ChevronRight: (p) => <Icon {...p} path='<polyline points="9 18 15 12 9 6"/>' />,
        ChevronDown: (p) => <Icon {...p} path='<polyline points="6 9 12 15 18 9"/>' />,
        Github: (p) => <Icon {...p} path='<path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/>' />,
        Flash: (p) => <Icon {...p} path='<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>' />,
        Edit: (p) => <Icon {...p} path='<path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/>' />,
        NewFolder: (p) => <Icon {...p} path='<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" x2="12" y1="11" y2="17"/><line x1="9" x2="15" y1="14" y2="14"/>' />,
        X: (p) => <Icon {...p} path='<path d="M18 6 6 18"/><path d="m6 6 12 12"/>' />,
        Refresh: (p) => <Icon {...p} path='<path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/>' />,
        Settings: (p) => <Icon {...p} path='<circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>' />
      };

      const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);

      const Editor = ({ file, onChange }) => {
        const textareaRef = useRef(null);
        useEffect(() => { if (textareaRef.current) textareaRef.current.scrollTop = 0; }, [file?.id]);
        const handleSelectAll = () => { if (textareaRef.current) { textareaRef.current.focus(); textareaRef.current.select(); } };
        if (!file) return <div className="flex-1 flex flex-col items-center justify-center text-gray-500 bg-editor-bg h-full"><Icons.Code size={48} className="mb-4 opacity-20" /><p>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</p></div>;
        return (
          <div className="flex flex-col h-full bg-editor-bg relative group">
            <div className="flex items-center justify-between px-4 py-2 bg-editor-sidebar border-b border-editor-border shrink-0">
              <span className="text-sm font-medium text-gray-200">{file.name}</span>
              <button onClick={handleSelectAll} className="flex flex-col items-center justify-center p-1 text-gray-500 hover:text-white rounded hover:bg-gray-700 w-12 transition-colors" title="å…¨é¸æŠ"><Icons.SelectAll size={18} /></button>
            </div>
            <textarea ref={textareaRef} value={file.content} onChange={(e) => onChange(e.target.value)} className="flex-1 w-full bg-editor-bg text-gray-300 font-mono text-sm p-4 resize-none focus:outline-none leading-6" spellCheck={false} autoCapitalize="off" placeholder="// ã“ã“ã«ã‚³ãƒ¼ãƒ‰ã‚’ãƒšãƒ¼ã‚¹ãƒˆ..." />
          </div>
        );
      };

      // --- â˜… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ³ã‚¸ãƒ³ (Blob URLæ–¹å¼ãƒ»User-Firstç‰ˆ) ---
      const Preview = ({ files }) => {
        const [previewUrl, setPreviewUrl] = useState('');
        const [mode, setMode] = useState('auto'); // auto, react, html
        const [refreshKey, setRefreshKey] = useState(0);

        useEffect(() => { return () => { if (previewUrl) URL.revokeObjectURL(previewUrl); }; }, [previewUrl]);

        useEffect(() => {
          try {
            const fileMap = {}; files.forEach(f => fileMap[f.name] = f.content);
            
            // ãƒ•ã‚¡ã‚¤ãƒ«åˆ¤å®š
            let entryFile = files.find(f => ['src/main.tsx', 'src/index.tsx', 'main.tsx'].includes(f.name));
            let rawHtml = fileMap['index.html'] || files.find(f => f.name.endsWith('.html'))?.content || "";
            
            // â˜…é‡è¦åˆ¤å®š: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã§ImportMapã‚’æ›¸ã„ã¦ã„ã‚‹ã‹ï¼Ÿ
            const hasUserImportMap = rawHtml.includes('type="importmap"');

            let isReactMode = false;
            if (mode === 'react') isReactMode = true;
            else if (mode === 'html') isReactMode = false;
            else {
                // Auto: main.tsxãŒã‚ã‚‹ã€ã¾ãŸã¯ .tsx/.jsx ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã£ã¦ index.html ãŒãªã„å ´åˆ
                isReactMode = (!!entryFile || (files.some(f => /\.(tsx|jsx)$/.test(f.name)) && !fileMap['index.html']));
            }

            // ã‚‚ã—ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒImportMapã‚’æ›¸ã„ã¦ã„ã‚‹ãªã‚‰ã€ãƒ¢ãƒ¼ãƒ‰ã«é–¢ä¿‚ãªãã€ŒHTMLãƒ¢ãƒ¼ãƒ‰(å¹²æ¸‰ãªã—)ã€ã«ã™ã‚‹
            if (hasUserImportMap) isReactMode = false;

            let finalContent = "";

            if (isReactMode) {
                // --- CodePlay Managed Mode (Auto-Wrap for React) ---
                // ã“ã“ã¯ä»Šã¾ã§é€šã‚Šã€‚Reactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã ã‘ã®æ™‚ã«ãŠä¸–è©±ã‚’ã™ã‚‹ã€‚
                
                // Virtual Wrapper Logic...
                let wrapperScript = "";
                if (!entryFile) {
                    const candidate = files.find(f => /\.(tsx|jsx|js)$/.test(f.name) && !f.name.includes('vite.config'));
                    if (candidate) {
                        entryFile = { name: 'virtual-main.tsx' };
                        const isDefaultExport = candidate.content.includes('export default');
                        if (isDefaultExport) {
                            wrapperScript = `import React from 'react'; import ReactDOM from 'react-dom/client'; import App from './${candidate.name}'; const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);`;
                        } else {
                            wrapperScript = `import './${candidate.name}';`;
                        }
                    }
                }

                if (!rawHtml) rawHtml = `<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"></head><body><div id="root"></div></body></html>`;

                // CSS injection
                const css = files.filter(f => f.name.endsWith('.css')).map(f => f.content).join('\n');
                const styleTag = `<style>${css} body { background-color: white; margin: 0; }</style>`;
                if (rawHtml.includes('</head>')) rawHtml = rawHtml.replace('</head>', `${styleTag}</head>`); else rawHtml += styleTag;

                // Libs
                const libs = `<script src="https://cdn.tailwindcss.com"><\/script><script src="https://unpkg.com/react@18/umd/react.production.min.js"><\/script><script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"><\/script><script src="https://unpkg.com/@babel/standalone/babel.min.js"><\/script>`;
                if (rawHtml.includes('<head>')) rawHtml = rawHtml.replace('<head>', `<head>${libs}`); else rawHtml = libs + rawHtml;

                // Blob URLs & Import Map
                const blobUrls = {};
                files.filter(f => /\.(ts|tsx|js|jsx|css)$/.test(f.name)).forEach(file => {
                    let code = file.content;
                    if (file.name.endsWith('.css')) {
                        code = `const s = new CSSStyleSheet(); s.replaceSync(\`${file.content.replace(/`/g, '\\`')}\`); export default s;`;
                    } else {
                        try { code = Babel.transform(file.content, { presets: [['env', { modules: false }], 'react', 'typescript'], filename: file.name }).code; } catch(e) { console.error(e); }
                    }
                    const blob = new Blob([code], { type: 'application/javascript' });
                    const url = URL.createObjectURL(blob);
                    blobUrls[`./${file.name}`] = url;
                    blobUrls[`./${file.name.replace(/\.[^/.]+$/, "")}`] = url;
                });

                const imports = { 
                    "react": "https://esm.sh/react@18.2.0", "react-dom/client": "https://esm.sh/react-dom@18.2.0/client", "react-dom": "https://esm.sh/react-dom@18.2.0", 
                    "lucide-react": "https://esm.sh/lucide-react@0.330.0", "recharts": "https://esm.sh/recharts@2.12.0", "framer-motion": "https://esm.sh/framer-motion@10.16.4", 
                    "canvas-confetti": "https://esm.sh/canvas-confetti@1.9.2", "clsx": "https://esm.sh/clsx@2.1.0", "tailwind-merge": "https://esm.sh/tailwind-merge@2.2.1", 
                    "@google/genai": "https://esm.sh/@google/genai@0.1.1", ...blobUrls 
                };
                const importMapScript = `<script type="importmap">{ "imports": ${JSON.stringify(imports)} }<\/script>`;
                rawHtml = rawHtml.replace('</head>', `${importMapScript}</head>`).replace(/<script\s+type=["']module["']\s+src=["']([^"']+)["']\s*><\/script>/gi, '');

                let entryCode = "";
                if (wrapperScript) { try { entryCode = Babel.transform(wrapperScript, { presets: ['env', 'react', 'typescript'], filename: 'virtual.tsx' }).code; } catch(e){} }
                else if (entryFile && blobUrls[`./${entryFile.name}`]) { entryCode = `import './${entryFile.name}';`; }

                const executionScript = `<script type="module">document.adoptedStyleSheets = []; ${files.filter(f => f.name.endsWith('.css')).map((f,i) => `import s${i} from './${f.name}'; document.adoptedStyleSheets.push(s${i});`).join('\n')} ${entryCode} <\/script>`;
                if(rawHtml.includes('</body>')) rawHtml = rawHtml.replace('</body>', `${executionScript}</body>`); else rawHtml += executionScript;
                finalContent = rawHtml;

            } else {
                // --- â˜… Standalone HTML Mode (Do NOT interfere) ---
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã§HTMLã¨ImportMapã‚’æ›¸ã„ã¦ã„ã‚‹å ´åˆã€‚
                // CodePlayã¯ã€ŒãŸã ã®iframeè¡¨ç¤ºå™¨ã€ã«å¾¹ã™ã‚‹ã€‚
                
                // ãŸã ã—ã€åˆ©ä¾¿æ€§ã®ãŸã‚Babelå¤‰æ›ã ã‘ã¯æ‰‹ä¼ã†ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãƒã‚¤ãƒ†ã‚£ãƒ–ã§ã¯JSXãŒå‹•ã‹ãªã„ãŸã‚ï¼‰
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¢ã«Babel CDNã‚’æ›¸ã„ã¦ã„ã‚‹å ´åˆã¯äºŒé‡ãƒ­ãƒ¼ãƒ‰ã‚’é˜²ã
                
                // 1. ã‚‚ã—ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒImportMapã‚’æ›¸ã„ã¦ã„ãªã„ãªã‚‰ã€æœ€ä½é™ã®Mapã ã‘å…¥ã‚Œã¦ã‚ã’ã‚‹ï¼ˆè¦ªåˆ‡å¿ƒï¼‰
                //    æ›¸ã„ã¦ã‚ã‚‹ãªã‚‰ä½•ã‚‚ã—ãªã„ï¼ˆã“ã“ãŒä¿®æ­£ç‚¹ï¼ï¼‰
                if (!hasUserImportMap) {
                     const defaultImports = { "react": "https://esm.sh/react@18.2.0", "react-dom/client": "https://esm.sh/react-dom@18.2.0/client", "lucide-react": "https://esm.sh/lucide-react@0.330.0", "recharts": "https://esm.sh/recharts@2.12.0" };
                     const mapScript = `<script type="importmap">{ "imports": ${JSON.stringify(defaultImports)} }<\/script>`;
                     if (rawHtml.includes('<head>')) rawHtml = rawHtml.replace('<head>', `<head>${mapScript}`); else rawHtml = mapScript + rawHtml;
                }

                // 2. JSXã®å¤‰æ› (ã“ã‚Œã¯ãƒ–ãƒ©ã‚¦ã‚¶ãŒã§ããªã„ã®ã§CodePlayãŒã‚„ã‚‹ã—ã‹ãªã„)
                const regex = /<script\s+([^>]*?)type=["']text\/babel["']([^>]*?)>([\s\S]*?)<\/script>/gi;
                finalContent = rawHtml.replace(regex, (match, preAttrs, postAttrs, code) => {
                   try {
                       const res = Babel.transform(code, { presets: [['env', { modules: false, targets: { esmodules: true } }], 'react', 'typescript'], filename: 'script.tsx' });
                       const hasImport = code.includes('import ') || match.includes('data-type="module"');
                       return `<script ${preAttrs} ${hasImport ? 'type="module"' : ''} ${postAttrs}>${res.code}<\/script>`;
                   } catch(e) { return `<script>document.body.innerHTML += '<div style="color:red">Error: ${e.message}</div>'<\/script>`; }
                });

                // Remove CDN babel to avoid double load if user included it
                finalContent = finalContent.replace(/<script\s+src=["'].*babel.*["']><\/script>/gi, '');
            }

            const blob = new Blob([finalContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            setPreviewUrl(url);

          } catch(e) { console.error(e); }
        }, [files, refreshKey, mode]);

        return (
          <div className="flex flex-col h-full bg-white">
            <div className="flex items-center justify-between px-2 py-1 bg-gray-100 border-b border-gray-300 shrink-0 h-8">
              <div className="flex items-center gap-2">
                 <span className="text-xs text-gray-500 font-bold flex gap-1 items-center"><Icons.Settings size={12}/> Mode:</span>
                 <select value={mode} onChange={(e)=>setMode(e.target.value)} className="text-xs bg-white border border-gray-300 rounded px-1 py-0.5 outline-none text-gray-700">
                    <option value="auto">Auto Detect</option>
                    <option value="react">React (Module)</option>
                    <option value="html">HTML (Classic)</option>
                 </select>
              </div>
              <button onClick={()=>setRefreshKey(k=>k+1)} className="text-gray-500 hover:text-blue-600" title="Reload"><Icons.Refresh size={14}/></button>
            </div>
            <iframe src={previewUrl} className="flex-1 w-full h-full border-none" sandbox="allow-scripts allow-modals allow-same-origin allow-forms allow-downloads" />
          </div>
        );
      };

      // --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ ---
      const Sidebar = ({ isOpen, onClose, projects, onSave, onLoad, onDelete, onClear, onImportJSON }) => {
        const fileInputRef = useRef(null);
        const handleExportJSON = () => {
          const blob = new Blob([JSON.stringify(projects, null, 2)], { type: "application/json" });
          const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `codeplay_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };
        const handleFileChange = (e) => {
          const reader = new FileReader(); reader.onload = (event) => { try { onImportJSON(JSON.parse(event.target.result)); alert("å¾©å…ƒã—ã¾ã—ãŸï¼"); } catch { alert("ã‚¨ãƒ©ãƒ¼"); } }; reader.readAsText(e.target.files[0]); e.target.value = '';
        };
        if(!isOpen) return null;
        return (
            <div className="fixed inset-0 z-50 flex">
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose} />
                <div className="relative w-80 max-w-[85%] bg-gray-900 border-r border-gray-700 flex flex-col h-full shadow-2xl animate-in slide-in-from-left duration-200">
                    <div className="p-4 border-b border-gray-800 flex justify-between items-center h-16"><span className="text-white font-bold flex gap-2 items-center"><Icons.Folder size={20} className="text-blue-500"/> ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</span><button onClick={onClose}><Icons.X size={20} className="text-gray-400"/></button></div>
                    <div className="p-4 space-y-3 border-b border-gray-800">
                         <button onClick={onSave} className="w-full bg-blue-600 text-white py-2 rounded text-sm font-bold hover:bg-blue-500">ä¿å­˜ã™ã‚‹</button>
                         <div className="flex gap-2">
                            <button onClick={handleExportJSON} className="flex-1 bg-gray-800 text-gray-300 py-2 rounded text-xs flex items-center justify-center gap-1 border border-gray-700"><Icons.Download size={14}/> ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
                            <button onClick={()=>fileInputRef.current.click()} className="flex-1 bg-gray-800 text-gray-300 py-2 rounded text-xs flex items-center justify-center gap-1 border border-gray-700"><Icons.Upload size={14}/> å¾©å…ƒ</button>
                            <input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".json" className="hidden" />
                         </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-2 space-y-2">
                        {projects.length===0 && <div className="text-center text-gray-500 text-xs mt-10">ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>}
                        {projects.map(p => (
                            <div key={p.id} className="bg-gray-800 p-3 rounded flex justify-between items-center group">
                                <div onClick={()=>{if(confirm('èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ(ç¾åœ¨ã®ç·¨é›†å†…å®¹ã¯å¤±ã‚ã‚Œã¾ã™)')){onLoad(p);onClose()}}} className="flex-1 cursor-pointer">
                                    <div className="text-sm font-bold text-gray-200">{p.name}</div>
                                    <div className="text-xs text-gray-500">{new Date(p.createdAt).toLocaleDateString()}</div>
                                </div>
                                <button onClick={()=>onDelete(p.id)} className="text-gray-500 hover:text-red-400 p-2"><Icons.Trash2 size={16}/></button>
                            </div>
                        ))}
                    </div>
                    <div className="p-4 border-t border-gray-800"><button onClick={onClear} className="w-full text-red-500 text-xs py-2 border border-red-900/30 rounded">å…¨å±¥æ­´ã‚’æ¶ˆå»</button></div>
                </div>
            </div>
        );
      };

      const buildFileTree = (files) => {
        const root = { name: "root", isFolder: true, children: {}, path: "" };
        files.forEach(file => {
          const parts = file.name.split('/');
          let current = root;
          parts.forEach((part, index) => {
            const currentPath = parts.slice(0, index + 1).join('/');
            if (index === parts.length - 1) current.children[part] = { ...file, isFolder: false, path: file.name };
            else { if (!current.children[part]) current.children[part] = { name: part, isFolder: true, children: {}, path: currentPath }; current = current.children[part]; }
          });
        });
        return root;
      };

      const FileTreeNode = ({ node, activeFileId, onSelect, onDelete, onRenameFile, onRenameFolder, onDeleteFolder, depth = 0 }) => {
        const [isOpen, setIsOpen] = useState(true);
        if (!node.isFolder) {
          return <div onClick={() => onSelect(node.id)} className={`group flex justify-between items-center py-1.5 pr-2 cursor-pointer text-sm hover:bg-gray-800 ${activeFileId === node.id ? 'bg-editor-active text-white border-l-2 border-l-blue-500' : 'text-gray-400 border-l-2 border-transparent'}`} style={{ paddingLeft: `${depth * 12 + 12}px` }}>
                <div className="flex items-center gap-1.5 min-w-0 overflow-hidden"><Icons.File size={14} className="shrink-0 opacity-70" /><span className="truncate">{node.name.split('/').pop()}</span></div>
                <div className="flex opacity-0 group-hover:opacity-100 transition-opacity gap-1"><button onClick={(e)=>{e.stopPropagation(); onRenameFile(node);}} className="text-gray-500 hover:text-white"><Icons.Edit size={13}/></button><button onClick={(e)=>{e.stopPropagation(); if(confirm(`å‰Šé™¤: ${node.name}?`)) onDelete(node.id);}} className="text-gray-500 hover:text-red-400"><Icons.Trash2 size={13}/></button></div>
             </div>;
        }
        const children = Object.values(node.children).sort((a, b) => (a.isFolder === b.isFolder ? a.name.localeCompare(b.name) : a.isFolder ? -1 : 1));
        if (node.name === "root") return <div className="flex flex-col">{children.map((child) => <FileTreeNode key={child.path} node={child} activeFileId={activeFileId} onSelect={onSelect} onDelete={onDelete} onRenameFile={onRenameFile} onRenameFolder={onRenameFolder} onDeleteFolder={onDeleteFolder} depth={0} />)}</div>;
        return (
          <div className="flex flex-col select-none">
            <div onClick={() => setIsOpen(!isOpen)} className={`group flex justify-between items-center py-1.5 pr-2 cursor-pointer text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors`} style={{ paddingLeft: `${depth * 12 + 6}px` }}>
              <div className="flex items-center gap-1 min-w-0 overflow-hidden"><span className="p-0.5 text-gray-500">{isOpen ? <Icons.ChevronDown size={14}/> : <Icons.ChevronRight size={14}/>}</span><Icons.Folder size={14} className="shrink-0 text-blue-400" /><span className="truncate font-medium">{node.name}</span></div>
              <div className="flex opacity-0 group-hover:opacity-100 transition-opacity gap-1"><button onClick={(e)=>{e.stopPropagation(); onRenameFolder(node.path, node.name);}} className="text-gray-500 hover:text-white"><Icons.Edit size={13}/></button><button onClick={(e)=>{e.stopPropagation(); if(confirm(`ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤: ${node.name}?`)) onDeleteFolder(node.path);}} className="text-gray-500 hover:text-red-400"><Icons.Trash2 size={13}/></button></div>
            </div>
            {isOpen && <div className="flex flex-col">{children.map((child) => <FileTreeNode key={child.path} node={child} activeFileId={activeFileId} onSelect={onSelect} onDelete={onDelete} onRenameFile={onRenameFile} onRenameFolder={onRenameFolder} onDeleteFolder={onDeleteFolder} depth={depth + 1} />)}</div>}
          </div>
        );
      };

      const FileExplorer = ({ files, activeFileId, onSelect, onAdd, onDelete, onUpload, onRenameFile, onRenameFolder, onDeleteFolder, onGitHub, onGenerateConfig }) => {
        const [name, setName] = useState('');
        const [isAdding, setIsAdding] = useState(false);
        const fileInputRef = useRef(null);
        const fileTree = useMemo(() => buildFileTree(files), [files]);
        const handleSubmit = (e) => { e.preventDefault(); if(!name)return; onAdd(name, 'text', ''); setName(''); setIsAdding(false); };
        const handleCreateFolder = () => { const n = prompt("ãƒ•ã‚©ãƒ«ãƒ€å:"); if(n) onAdd(`${n}/.keep`, 'text', ''); };
        const handleDownloadZip = async () => {
          if (!window.JSZip) { alert('JSZip library not loaded.'); return; }
          const zip = new JSZip(); files.forEach(f => { if(!f.name.endsWith('.keep')) zip.file(f.name, f.content); });
          const content = await zip.generateAsync({type: "blob"});
          const link = document.createElement('a'); link.href = URL.createObjectURL(content); link.download = `project_${new Date().getTime()}.zip`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };
        const handleUpload = (e) => { Array.from(e.target.files).forEach(file => { const r = new FileReader(); r.onload = (ev) => onUpload(file.name, ev.target.result, 'text'); r.readAsText(file); }); e.target.value = ''; }
        return (
          <div className="flex flex-col h-full bg-editor-sidebar border-r border-editor-border">
             <div className="p-3 border-b border-editor-border flex flex-col gap-2 shrink-0">
               <div className="flex justify-between items-center"><span className="text-xs font-bold text-gray-400">ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</span></div>
               <button onClick={onGenerateConfig} className="w-full text-[10px] bg-blue-900/50 text-blue-300 border border-blue-800 py-1 rounded hover:bg-blue-800/50 flex items-center justify-center gap-1"><Icons.Flash size={12}/> Cloudflareè¨­å®šç”Ÿæˆ</button>
               <div className="flex gap-1 justify-between pt-1">
                 <button onClick={onGitHub} className="text-gray-400 hover:text-white p-1" title="GitHubã¸ãƒ—ãƒƒã‚·ãƒ¥"><Icons.Github size={16}/></button>
                 <button onClick={handleDownloadZip} className="text-gray-400 hover:text-white p-1" title="ZIPä¿å­˜"><Icons.Archive size={16}/></button>
                 <button onClick={()=>fileInputRef.current.click()} className="text-gray-400 hover:text-white p-1" title="èª­è¾¼"><Icons.Upload size={16}/></button>
                 <button onClick={handleCreateFolder} className="text-gray-400 hover:text-white p-1" title="ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ"><Icons.NewFolder size={16}/></button>
                 <button onClick={()=>setIsAdding(!isAdding)} className="text-gray-400 hover:text-white p-1" title="ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ "><Icons.Plus size={16}/></button>
               </div>
               <input type="file" multiple ref={fileInputRef} onChange={handleUpload} className="hidden" />
             </div>
             {isAdding && <form onSubmit={handleSubmit} className="p-2 bg-gray-800 shrink-0 border-b border-editor-border"><input value={name} onChange={e=>setName(e.target.value)} className="w-full bg-gray-900 text-white text-sm p-2 rounded outline-none border border-blue-500" placeholder="ä¾‹: App.tsx" autoFocus onBlur={()=>{if(!name)setIsAdding(false)}}/></form>}
             <div className="flex-1 overflow-y-auto group">
               {files.length === 0 ? <div className="p-4 text-xs text-center text-gray-600">ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</div> : <FileTreeNode node={fileTree} activeFileId={activeFileId} onSelect={onSelect} onDelete={onDelete} onRenameFile={onRenameFile} onRenameFolder={onRenameFolder} onDeleteFolder={onDeleteFolder} />}
             </div>
          </div>
        );
      };

      const GitHubModal = ({ isOpen, onClose, files }) => {
         const [token, setToken] = useState(localStorage.getItem('cp_gh_token') || '');
         const [repo, setRepo] = useState(localStorage.getItem('cp_gh_repo') || '');
         const [branch, setBranch] = useState(localStorage.getItem('cp_gh_branch') || 'main');
         const [status, setStatus] = useState('');
         const [isUploading, setIsUploading] = useState(false);
         const handlePush = async () => {
             if(!token || !repo) return alert('Tokenã¨ãƒªãƒã‚¸ãƒˆãƒªåã¯å¿…é ˆã§ã™');
             localStorage.setItem('cp_gh_token', token); localStorage.setItem('cp_gh_repo', repo); localStorage.setItem('cp_gh_branch', branch);
             setIsUploading(true); setStatus('æ¥ç¶šä¸­...');
             try {
                const headers = { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' };
                const repoUrl = `https://api.github.com/repos/${repo}`;
                let res = await fetch(repoUrl, { headers });
                if (!res.ok) throw new Error(`ãƒªãƒã‚¸ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${res.status}`);
                const validFiles = files.filter(f => !f.name.endsWith('.keep'));
                for (const file of validFiles) {
                    setStatus(`Uploading ${file.name}...`);
                    const content = btoa(unescape(encodeURIComponent(file.content)));
                    const fileUrl = `${repoUrl}/contents/${file.name}`;
                    let sha = null;
                    try { const check = await fetch(fileUrl + `?ref=${branch}`, { headers }); if(check.ok) sha = (await check.json()).sha; } catch(e){}
                    const body = { message: `Update ${file.name} via CodePlay`, content, branch, ...(sha ? {sha} : {}) };
                    const put = await fetch(fileUrl, { method: 'PUT', headers, body: JSON.stringify(body) });
                    if(!put.ok) throw new Error(`Failed: ${file.name}`);
                }
                setStatus('å®Œäº†ã—ã¾ã—ãŸï¼');
             } catch(e) { setStatus('Error: ' + e.message); } finally { setIsUploading(false); }
         };
         if(!isOpen) return null;
         return (
             <div className="fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-4">
                 <div className="bg-gray-900 border border-gray-700 rounded-lg w-full max-w-md p-6 shadow-2xl">
                     <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><Icons.Github size={24}/> GitHubã¸ãƒ—ãƒƒã‚·ãƒ¥</h2>
                     <div className="space-y-3">
                         <div><label className="text-xs text-gray-400">GitHub Token</label><input value={token} onChange={e=>setToken(e.target.value)} type="password" class="w-full bg-gray-800 text-white p-2 rounded border border-gray-700 mt-1"/></div>
                         <div><label className="text-xs text-gray-400">Repo (user/repo)</label><input value={repo} onChange={e=>setRepo(e.target.value)} class="w-full bg-gray-800 text-white p-2 rounded border border-gray-700 mt-1"/></div>
                         <div className="text-xs font-mono text-green-400 min-h-[20px]">{status}</div>
                         <div className="flex justify-end gap-2 mt-2"><button onClick={onClose} className="px-4 py-2 text-sm text-gray-400">é–‰ã˜ã‚‹</button><button onClick={handlePush} disabled={isUploading} className="px-4 py-2 text-sm bg-green-600 text-white rounded font-bold">{isUploading?'...':'Push'}</button></div>
                     </div>
                 </div>
             </div>
         );
      };

      const App = () => {
        const INITIAL_FILES = [];
        const [files, setFiles] = useState(() => { try { return JSON.parse(localStorage.getItem('cp_files') || '[]'); } catch { return []; } });
        const [activeId, setActiveId] = useState(null);
        const [sidebarOpen, setSidebarOpen] = useState(false);
        const [mobileTab, setMobileTab] = useState('files');
        const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
        const [showGithub, setShowGithub] = useState(false);
        const [projects, setProjects] = useState(() => { try { return JSON.parse(localStorage.getItem('cp_projects')||'[]'); } catch{ return []; } });
        
        useEffect(() => localStorage.setItem('cp_projects', JSON.stringify(projects)), [projects]);
        useEffect(() => localStorage.setItem('cp_files', JSON.stringify(files)), [files]);
        useEffect(() => { const h = () => setIsMobile(window.innerWidth < 768); window.addEventListener('resize', h); return () => window.removeEventListener('resize', h); }, []);

        const handleRenameFile = (node) => { const n = prompt("ãƒ•ã‚¡ã‚¤ãƒ«åå¤‰æ›´:", node.name); if (n && n !== node.name) setFiles(prev => prev.map(f => f.id === node.id ? { ...f, name: n } : f)); };
        const handleRenameFolder = (oldP, oldN) => { const n = prompt("ãƒ•ã‚©ãƒ«ãƒ€åå¤‰æ›´:", oldN); if (n && n !== oldN) { const pre = oldP + "/", parent = oldP.substring(0, oldP.lastIndexOf('/')), newP = parent ? `${parent}/${n}` : n; setFiles(prev => prev.map(f => f.name.startsWith(pre) ? { ...f, name: f.name.replace(oldP, newP) } : f)); }};
        const handleDeleteFolder = (path) => setFiles(prev => prev.filter(f => !f.name.startsWith(path + "/")));
        const handleSaveProject = (name) => {
            if(!name) return;
            const newProj = { id: generateId(), name, files, createdAt: Date.now() };
            setProjects(prev => [newProj, ...prev]);
            alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        };

        const handleGenerateConfig = () => {
            if(files.length > 0 && !confirm('Cloudflareç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ(ä¸Šæ›¸ãæ³¨æ„)')) return;
            const template = [
                { name: "package.json", content: JSON.stringify({ "name": "codeplay-app", "private": true, "version": "0.0.0", "type": "module", "scripts": { "dev": "vite", "build": "tsc && vite build", "preview": "vite preview" }, "dependencies": { "lucide-react": "^0.330.0", "react": "^18.2.0", "react-dom": "^18.2.0", "recharts": "^2.12.0", "xlsx": "^0.18.5", "@google/genai": "^0.1.1" }, "devDependencies": { "@types/react": "^18.2.55", "@types/react-dom": "^18.2.19", "@vitejs/plugin-react": "^4.2.1", "autoprefixer": "^10.4.17", "postcss": "^8.4.35", "tailwindcss": "^3.4.1", "typescript": "^5.2.2", "vite": "^5.1.0" } }, null, 2) },
                { name: "vite.config.ts", content: `import { defineConfig } from 'vite';\nimport react from '@vitejs/plugin-react';\nexport default defineConfig({ plugins: [react()] });` },
                { name: "index.html", content: `<!DOCTYPE html>\n<html lang="ja">\n<head>\n<meta charset="UTF-8" />\n<meta name="viewport" content="width=device-width, initial-scale=1.0" />\n<title>App</title>\n<script src="https://cdn.tailwindcss.com"><\/script>\n</head>\n<body>\n<div id="root"></div>\n<script type="module" src="/src/main.tsx"><\/script>\n</body>\n</html>` },
                { name: "src/main.tsx", content: `import React from 'react';\nimport ReactDOM from 'react-dom/client';\nimport App from './App';\n\nReactDOM.createRoot(document.getElementById('root')!).render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>\n);` },
                { name: "src/App.tsx", content: `import React from 'react';\n\nexport default function App() {\n  return (\n    <div className="p-10 bg-gray-900 min-h-screen text-white flex items-center justify-center">\n      <h1 className="text-3xl font-bold">Hello CodePlay!</h1>\n    </div>\n  );\n}` }
            ];
            const newFiles = template.map(t => ({ id: generateId(), name: t.name, content: t.content }));
            setFiles(newFiles);
            setActiveId(newFiles.find(f => f.name === 'src/App.tsx')?.id);
        };

        const activeFile = files.find(f => f.id === activeId);

        return (
          <div className="flex flex-col h-full text-white font-sans bg-gray-900">
            <header className="bg-editor-sidebar border-b border-editor-border p-1 flex items-center justify-between shrink-0 h-16 z-20 shadow-md">
               <div className="flex items-center gap-2 pl-1">
                 <button onClick={()=>setSidebarOpen(true)} className="flex flex-col items-center justify-center p-2 text-gray-400 hover:text-white rounded hover:bg-gray-700 w-14"><Icons.Menu size={20}/><span className="text-[10px] mt-0.5">Menu</span></button>
                 <div className="flex flex-col justify-center"><span className="font-bold text-base tracking-tight leading-tight">CodePlay</span><span className="text-[10px] text-gray-500 leading-tight">Editor</span></div>
               </div>
               <div className="flex items-center gap-1 pr-1"><button onClick={()=>{if(confirm('ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')){setFiles([]); setActiveId(null);}}} className="flex flex-col items-center justify-center p-2 text-gray-400 hover:text-white rounded hover:bg-gray-700 w-14"><Icons.RotateCcw size={18}/><span className="text-[10px] mt-0.5">Reset</span></button></div>
            </header>
            <main className="flex-1 flex overflow-hidden relative">
               <div className={`${(isMobile && mobileTab !== 'files') ? 'hidden' : 'flex'} w-full md:w-56 md:flex-none flex-col h-full z-10 border-r border-editor-border bg-editor-sidebar`}>
                  <FileExplorer files={files} activeFileId={activeId} onSelect={(id)=>{setActiveId(id); if(isMobile) setMobileTab('editor');}} onAdd={(n,l,c)=>setFiles([...files, {id:generateId(), name:n, language:l, content:c||''} ])} onDelete={(id)=>{setFiles(f=>f.filter(x=>x.id!==id)); if(activeId===id) setActiveId(null);}} onUpload={(n,c,l)=>setFiles(prev=>[...prev, {id:generateId(), name:n, language:l, content:c}])} onRenameFile={handleRenameFile} onRenameFolder={handleRenameFolder} onDeleteFolder={handleDeleteFolder} onGitHub={()=>setShowGithub(true)} onGenerateConfig={handleGenerateConfig} />
               </div>
               <div className={`${(isMobile && mobileTab !== 'editor') ? 'hidden' : 'flex'} flex-1 flex-col min-w-0 md:border-r border-editor-border md:max-w-[50%]`}>
                 <Editor file={activeFile} onChange={(val)=>setFiles(files.map(f=>f.id===activeId?{...f, content:val}:f))} />
               </div>
               <div className={`${(isMobile && mobileTab !== 'preview') ? 'hidden' : 'flex'} flex-1 flex-col bg-white h-full`}><Preview files={files} /></div>
            </main>
            <div className="md:hidden h-16 bg-editor-sidebar border-t border-editor-border flex items-center justify-around shrink-0 pb-safe z-30">
              <button onClick={()=>setMobileTab('files')} className={`flex flex-col items-center justify-center gap-0.5 w-full h-full ${mobileTab==='files'?'text-blue-400 bg-gray-800':'text-gray-500'}`}><Icons.List size={20}/><span className="text-[10px]">Files</span></button>
              <button onClick={()=>setMobileTab('editor')} className={`flex flex-col items-center justify-center gap-0.5 w-full h-full ${mobileTab==='editor'?'text-blue-400 bg-gray-800':'text-gray-500'}`}><Icons.Code size={20}/><span className="text-[10px]">Code</span></button>
              <button onClick={()=>setMobileTab('preview')} className={`flex flex-col items-center justify-center gap-0.5 w-full h-full ${mobileTab==='preview'?'text-blue-400 bg-gray-800':'text-gray-500'}`}><Icons.Play size={20}/><span className="text-[10px]">Run</span></button>
            </div>
            <GitHubModal isOpen={showGithub} onClose={()=>setShowGithub(false)} files={files} />
            <Sidebar isOpen={sidebarOpen} onClose={()=>setSidebarOpen(false)} projects={projects} onSave={()=>{const n=prompt('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå:'); if(n) handleSaveProject(n)}} onLoad={(p)=>{setFiles(p.files); setActiveId(p.files[0]?.id)}} onDelete={(id)=>setProjects(p=>p.filter(x=>x.id!==id))} onClear={()=>{if(confirm('å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) setProjects([])}} onImportJSON={(json)=>setProjects(prev => [...json, ...prev])} />
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById('root')).render(e(App));
    </script>
  </body>
</html>
